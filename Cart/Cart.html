<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KMITL Store - Cart</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800&family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../responsive/responsive.css" />
    <link rel="stylesheet" href="Cart.css" />
    <script src="../Components/Navbar.js" defer></script>
    <script src="../Components/Footer.js" defer></script>
  </head>

  <body>
    <my-navbar></my-navbar>

    <div class="store-container">
      <div class="cart-container">
        <h1>CART</h1>
        <div class="cart-items">
          <!-- สินค้าจะถูกแสดงที่นี่โดย loadCart() -->
        </div>

        <div class="total-container">
          <button class="total-price">0 ฿</button>
          <!-- Display total price -->
          <a href="../Address/Address.html">
            <button class="checkout-button">Check Out</button>
          </a>
        </div>
      </div>
    </div>

    <my-footer></my-footer>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        loadCart();

        // Restore saved total from localStorage, if available
        const savedTotal = localStorage.getItem("cartTotal") || 0;
        document.querySelector(".total-price").textContent = savedTotal + " ฿";
      });

      async function loadCart() {
        try {
          const response = await fetch("http://127.0.0.1:3000/cart", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (!response.ok) throw new Error("Network response was not ok");

          const cartItems = await response.json();
          const cartContainer = document.querySelector(".cart-items");
          cartContainer.innerHTML = ""; // Clear previous items

          cartItems.forEach((item, index) => {
            const cartItem = document.createElement("div");
            cartItem.classList.add("cart-item");
            cartItem.id = `cart-item-${item.product_id}`;

            cartItem.innerHTML = `
              <input type="checkbox" id="item${item.product_id}" class="item-checkbox">
              <label for="item${item.product_id}" class="item-label" data-price="${item.price}">
                  <img src="${item.image_url}" alt="${item.name}">
                  ${item.name}
                  <span class="item-price">${item.price}</span> ฿
              </label>
              <span class="item-quantity">x ${item.quantity}</span>
              <button class="delete-button" onclick="removeItem(${item.product_id})">Delete</button>
          `;

            // Add checkbox listener for updating the total
            cartItem
              .querySelector(".item-checkbox")
              .addEventListener("change", updateTotal);

            cartContainer.appendChild(cartItem);
          });

          restoreCheckboxStates(); // Restore checkbox states from localStorage
          updateTotal(); // Initial total update
        } catch (error) {
          console.error("Error loading cart:", error);
        }
      }

      function updateTotal() {
        let total = 0;
        const checkboxStates = {};

        document.querySelectorAll(".item-checkbox").forEach((checkbox) => {
          const itemId = checkbox.id;
          checkboxStates[itemId] = checkbox.checked; // Save checkbox state

          if (checkbox.checked) {
            const price = parseInt(
              checkbox.nextElementSibling.querySelector(".item-price")
                .textContent
            );
            total += price;
          }
        });

        document.querySelector(".total-price").textContent = total + " ฿";
        localStorage.setItem("cartTotal", total);
        localStorage.setItem("checkboxStates", JSON.stringify(checkboxStates));
      }

      function removeItem(itemId) {
        const cartItem = document.getElementById(`cart-item-${itemId}`);

        if (cartItem) {
          const productId = itemId; // Assuming itemId corresponds to productId

          fetch("http://127.0.0.1:3000/cart/remove", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`, // Assuming token is stored in localStorage
            },
            body: JSON.stringify({ productId: productId }),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Failed to remove item from cart");
              }
              return response.json();
            })
            .then((data) => {
              console.log(data.message); // Log the success message

              // Remove item from DOM and update total
              cartItem.remove();
              updateTotal();
            })
            .catch((error) => {
              console.error("Error removing item:", error);
            });
        }
      }

      function restoreCheckboxStates() {
        const savedCheckboxStates =
          JSON.parse(localStorage.getItem("checkboxStates")) || {};

        document.querySelectorAll(".item-checkbox").forEach((checkbox) => {
          const itemId = checkbox.id;
          checkbox.checked = savedCheckboxStates[itemId] || false;
        });
      }
    </script>
  </body>
</html>
